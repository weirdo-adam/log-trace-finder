<!doctype html>
<html>
    <head>
        <title>LogTraceFinder - 日志追踪查询自助工具</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="/static/style.css" />
        <style>
            /* 新增的样式部分 */
            .search-conditions {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 16px;
                margin-bottom: 20px;
            }

            .search-group {
                display: flex;
                flex-direction: column;
            }

            .search-group label {
                margin-bottom: 6px;
                font-weight: 500;
                color: #555;
                font-size: 14px;
            }

            .search-group input,
            .search-group select {
                padding: 10px 12px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 14px;
                transition: border-color 0.3s;
            }

            .search-group input:focus,
            .search-group select:focus {
                border-color: #4285f4;
                outline: none;
                box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
            }

            .search-actions {
                display: flex;
                gap: 12px;
                margin-top: 16px;
            }

            .search-button,
            .reset-button {
                padding: 10px 20px;
                border: none;
                border-radius: 4px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s;
            }

            .search-button {
                background-color: #4285f4;
                color: white;
            }

            .search-button:hover {
                background-color: #3367d6;
            }

            .reset-button {
                background-color: #f1f1f1;
                color: #555;
            }

            .reset-button:hover {
                background-color: #e0e0e0;
            }

            .result-filters {
                margin-top: 12px;
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                align-items: center;
            }

            .filter-tag {
                background-color: #e8f0fe;
                color: #1967d2;
                padding: 4px 10px;
                border-radius: 16px;
                font-size: 13px;
                display: inline-flex;
                align-items: center;
            }

            .limit-warning {
                color: #d93025;
                font-size: 14px;
                margin-left: 8px;
            }

            @media (max-width: 768px) {
                .search-conditions {
                    grid-template-columns: 1fr;
                }
            }
        </style>
        <script>
            // 之前的JavaScript代码保持不变
            function formatTimestamp(timestamp) {
                return timestamp.slice(0, 23);
            }
            function toggleLogBody(id) {
                const body = document.getElementById(id);
                const button = document.getElementById("btn-" + id);

                if (body.classList.contains("collapsed")) {
                    body.classList.remove("collapsed");
                    button.textContent = "折叠日志内容";
                    button.classList.add("expanded");
                } else {
                    body.classList.add("collapsed");
                    button.textContent = "展开日志内容";
                    button.classList.remove("expanded");
                }
            }

            function toggleLabels(id) {
                const labels = document.getElementById(id);
                const button = document.getElementById("btn-" + id);

                if (labels.classList.contains("collapsed")) {
                    labels.classList.remove("collapsed");
                    button.textContent = "折叠日志字段";
                    button.classList.add("expanded");
                } else {
                    labels.classList.add("collapsed");
                    button.textContent = "展开日志字段";
                    button.classList.remove("expanded");
                }
            }

            document.addEventListener("DOMContentLoaded", function () {
                const logBodies = document.querySelectorAll(".log-body");
                const logLabels = document.querySelectorAll(".log-labels");
                logBodies.forEach((body) => {
                    body.classList.add("collapsed");
                });

                logLabels.forEach((labels) => {
                    labels.classList.add("collapsed");
                });

                const timestamps = document.querySelectorAll(
                    ".timeline-timestamp",
                );
                timestamps.forEach(function (element) {
                    const originalTime = element.textContent.trim();
                    element.textContent = formatTimestamp(originalTime);
                    element.title = originalTime;
                });

                // 设置默认时间范围（最近1小时）UTC+8
                const now = new Date();
                const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);

                // 转换为本地时间字符串（UTC+8）
                function toLocalISOString(date) {
                    const offset = date.getTimezoneOffset();
                    const localTime = new Date(
                        date.getTime() - offset * 60 * 1000,
                    );
                    return localTime.toISOString().slice(0, 16);
                }

                document.getElementById("start_time").value =
                    toLocalISOString(oneHourAgo);
                document.getElementById("end_time").value =
                    toLocalISOString(now);
            });
        </script>
    </head>
    <body>
        <div class="container">
            <header class="header">
                <h1>LogTraceFinder</h1>
                <p class="subtitle">开发平台日志查询自助工具</p>
            </header>

            <form method="POST" class="search-form">
                <div class="search-conditions">
                    <!-- companyId 查询 -->
                    <div class="search-group">
                        <label for="company_id">公司ID</label>
                        <input
                            type="text"
                            id="company_id"
                            name="company_id"
                            value="{{ company_id }}"
                            placeholder="输入公司ID"
                        />
                    </div>

                    <!-- 日志内容关键词 -->
                    <div class="search-group">
                        <label for="keyword">关键词</label>
                        <input
                            type="text"
                            id="keyword"
                            name="keyword"
                            value="{{ keyword }}"
                            placeholder="输入日志内容关键词"
                        />
                    </div>

                    <!-- 日志链路ID -->
                    <div class="search-group">
                        <label for="trace_id">日志链路ID</label>
                        <input
                            type="text"
                            id="trace_id"
                            name="trace_id"
                            value="{{ trace_id }}"
                            placeholder="输入TraceID"
                        />
                    </div>

                    <!-- 接口地址 查询 -->
                    <div class="search-group">
                        <label for="request_uri">接口地址</label>
                        <input
                            type="text"
                            id="request_uri"
                            name="request_uri"
                            value="{{ request_uri }}"
                            placeholder="输入接口地址"
                        />
                    </div>

                    <!-- 时间范围选择 -->
                    <div class="search-group">
                        <label for="start_time">开始时间</label>
                        <input
                            type="datetime-local"
                            id="start_time"
                            name="start_time"
                            value="{{ start_time }}"
                        />
                    </div>

                    <div class="search-group">
                        <label for="end_time">结束时间</label>
                        <input
                            type="datetime-local"
                            id="end_time"
                            name="end_time"
                            value="{{ end_time }}"
                        />
                    </div>
                </div>

                <div class="search-actions">
                    <button type="submit" class="search-button">查询</button>
                    <button type="reset" class="reset-button">重置</button>
                </div>
            </form>

            <!-- 结果部分保持不变 -->
            <div class="results">
                {% if logs %}
                <div class="results-header">
                    <h2>查询结果</h2>
                    <p class="result-count">
                        共找到 {{ logs|length }} 条日志记录 {% if limit_reached
                        %}
                        <span class="limit-warning">(已达到最大显示限制)</span>
                        {% endif %}
                    </p>
                </div>

                <div class="timeline">
                    {% for log in logs %}
                    <div class="timeline-entry">
                        <span class="timeline-timestamp"
                            >{{ log.timestamp }}</span
                        >
                        <div class="log-entry level-{{ log.level|lower }}">
                            <div class="log-header">
                                <div class="log-meta">
                                    <span
                                        class="level level-{{ log.level|lower }}"
                                        >{{ log.level }}</span
                                    >
                                    <span
                                        class="level level-{{ log.level|lower }}"
                                        >{{ log.serviceName }}</span
                                    >
                                </div>
                                <div class="log-actions">
                                    <button
                                        class="toggle-btn"
                                        id="btn-log-{{ loop.index }}"
                                        onclick="toggleLogBody('log-{{ loop.index }}')"
                                    >
                                        展开日志内容
                                    </button>
                                    {% if log.labels %}
                                    <button
                                        class="toggle-btn labels-btn"
                                        id="btn-labels-{{ loop.index }}"
                                        onclick="toggleLabels('labels-{{ loop.index }}')"
                                    >
                                        展开日志字段
                                    </button>
                                    {% endif %}
                                </div>
                            </div>

                            {% if log.labels %}
                            <div
                                id="labels-{{ loop.index }}"
                                class="log-labels collapsed"
                            >
                                <div class="labels-container">
                                    {% for key, value in log.labels.items() %}
                                    <div class="label-row">
                                        <span class="label-key"
                                            >{{ key }}:</span
                                        >
                                        <span class="label-value"
                                            >{{ value }}</span
                                        >
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}

                            <div
                                id="log-{{ loop.index }}"
                                class="log-body collapsed"
                            >
                                {% if log.body is string %}
                                <pre>{{ log.body }}</pre>
                                {% else %}
                                <pre>{{ log.body|tojson(indent=2) }}</pre>
                                {% endif %}
                            </div>

                            <div class="log-footer">
                                <div class="trace-id-highlight">
                                    <span class="trace-id-label">追踪ID:</span>
                                    <span class="trace-id"
                                        >{{ log.traceID }}</span
                                    >
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% elif request.method == 'POST' %}
                <div class="no-results">
                    <p>没有找到符合条件的日志记录，请尝试其他查询条件</p>
                </div>
                {% endif %}
            </div>
        </div>
    </body>
</html>
