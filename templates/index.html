<!doctype html>
<html>
    <head>
        <title>LogTraceFinder - 日志追踪查询自助工具</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <style>
            :root {
                --primary-color: #4285f4;
                --success-color: #34a853;
                --warning-color: #fbbc05;
                --error-color: #ea4335;
                --info-color: #4285f4;
                --text-color: #333;
                --light-text: #666;
                --lighter-text: #999;
                --border-color: #e0e0e0;
                --light-bg: #f5f5f5;
                --lighter-bg: #fafafa;
                --label-bg: #f0f0f0;
                --debug-color: #9e9e9e;
                --info-color: #4285f4;
                --notice-color: #00bcd4;
                --warning-color: #ff9800;
                --error-color: #f44336;
                --critical-color: #d81b60;
                --alert-color: #ff5722;
                --emergency-color: #8e24aa;
            }

            * {
                box-sizing: border-box;
            }

            body {
                font-family:
                    "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                line-height: 1.6;
                margin: 0;
                padding: 20px;
                background-color: var(--light-bg);
                color: var(--text-color);
            }

            .container {
                max-width: 95%;
                margin: 0 auto;
                background: white;
                padding: 25px 30px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            }

            .header {
                margin-bottom: 25px;
                text-align: center;
            }

            .header h1 {
                color: var(--primary-color);
                margin: 0 0 5px 0;
                font-size: 2.2rem;
            }

            .subtitle {
                color: var(--light-text);
                margin: 0;
                font-size: 1.1rem;
            }

            .search-form {
                margin: 30px 0;
            }

            .search-box {
                display: flex;
                max-width: 800px;
                margin: 0 auto;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                border-radius: 6px;
                overflow: hidden;
            }

            .search-box input {
                flex: 1;
                padding: 12px 15px;
                font-size: 16px;
                border: 1px solid var(--border-color);
                border-right: none;
                border-radius: 6px 0 0 6px;
                transition: border-color 0.3s;
            }

            .search-box input:focus {
                outline: none;
                border-color: var(--primary-color);
            }

            .search-box button {
                padding: 0 25px;
                background: var(--primary-color);
                color: white;
                border: none;
                border-radius: 0 6px 6px 0;
                cursor: pointer;
                font-size: 16px;
                font-weight: 500;
                transition: background 0.3s;
            }

            .search-box button:hover {
                background: #3367d6;
            }

            .results-header {
                margin-bottom: 20px;
                padding-bottom: 10px;
                border-bottom: 1px solid var(--border-color);
            }

            .results-header h2 {
                margin: 0 0 5px 0;
                color: var(--text-color);
            }

            .result-count {
                margin: 0;
                color: var(--light-text);
                font-size: 0.95rem;
            }

            .log-list {
                margin-top: 25px;
            }

            .log-entry {
                border: 1px solid var(--border-color);
                padding: 20px;
                margin-bottom: 20px;
                border-radius: 6px;
                background: white;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
                transition: box-shadow 0.3s;
            }

            .log-entry:hover {
                box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            }

            .log-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
                flex-wrap: wrap;
                gap: 10px;
            }

            .log-meta {
                display: flex;
                align-items: center;
                gap: 15px;
            }

            .timestamp {
                color: var(--light-text);
                font-size: 0.9rem;
            }

            .level {
                font-weight: bold;
                padding: 3px 10px;
                border-radius: 4px;
                font-size: 0.85rem;
                text-transform: uppercase;
            }

            .level-info {
                background: rgba(66, 133, 244, 0.1);
                color: var(--info-color);
            }

            .level-warning {
                background: rgba(251, 188, 5, 0.1);
                color: var(--warning-color);
            }

            .level-error {
                background: rgba(234, 67, 53, 0.1);
                color: var(--error-color);
            }

            .level-fatal {
                background: var(--error-color);
                color: white;
            }

            .toggle-btn {
                padding: 6px 12px;
                background: var(--lighter-bg);
                border: 1px solid var(--border-color);
                border-radius: 4px;
                cursor: pointer;
                font-size: 0.85rem;
                color: var(--light-text);
                transition: all 0.3s;
            }

            .toggle-btn:hover {
                background: #e9e9e9;
            }

            .toggle-btn.expanded {
                background: var(--primary-color);
                color: white;
                border-color: var(--primary-color);
            }

            .log-labels {
                margin: 15px 0;
                padding: 15px;
                background: var(--lighter-bg);
                border-radius: 6px;
                border: 1px solid var(--border-color);
                transition: all 0.3s ease-out;
            }

            .log-labels.collapsed {
                max-height: 0;
                padding: 0;
                margin: 0;
                border: none;
                overflow: hidden;
            }

            .labels-title {
                margin: 0 0 10px 0;
                font-size: 0.95rem;
                color: var(--light-text);
                font-weight: 600;
            }

            .labels-container {
                display: flex;
                flex-direction: column;
                gap: 8px;
                width: 100%;
                overflow-y: auto;
                padding: 4px;
            }

            .label-row {
                display: grid;
                grid-template-columns: minmax(120px, 30%) 1fr;
                width: 100%;
                background: white;
                border-radius: 4px;
                border-left: 3px solid var(--primary-color);
                margin-bottom: 8px;
                overflow: hidden;
            }

            .label-key {
                font-weight: 600;
                color: var(--primary-color);
                border-right: 1px solid var(--border-color);
                background: var(--lighter-bg);
                word-break: break-word;
                overflow-wrap: break-word;
                white-space: normal;
                padding: 8px 12px;
                min-height: 38px;
                display: flex;
                align-items: center;
                line-height: 1.4;
            }

            .label-value {
                color: var(--text-color);
                background: white;
                word-break: break-word;
                overflow-wrap: break-word;
                white-space: pre-wrap;
                overflow: auto;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
                padding: 8px 12px;
                min-height: 38px;
                max-height: 150px;
                line-height: 1.4;
                display: grid; /* 使用 grid 布局 */
                align-items: center;
            }

            .log-body {
                white-space: pre-wrap;
                word-break: break-word;
                overflow-wrap: break-word;
                margin: 15px 0;
                padding: 15px;
                background: var(--lighter-bg);
                border-radius: 6px;
                font-family: "Consolas", "Monaco", monospace;
                font-size: 0.9rem;
                line-height: 1.5;
                color: var(--text-color);
                transition: all 0.3s ease-out;
                border: 1px solid var(--border-color);
                max-height: 500px;
                overflow-y: auto;
                overflow-x: auto;
            }

            .log-body pre {
                margin: 0;
                padding: 0;
                white-space: pre-wrap;
                word-break: break-word;
                font-size: inherit;
                font-family: inherit;
                line-height: inherit;
            }

            .log-body.collapsed {
                max-height: 0;
                padding: 0;
                margin: 0;
                border: none;
                overflow: hidden;
            }

            .log-footer {
                margin-top: 15px;
                padding-top: 10px;
                border-top: 1px solid var(--border-color);
                font-size: 0.85rem;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .trace-id-label {
                color: var(--light-text);
            }

            .trace-id {
                font-weight: 600;
                color: var(--primary-color);
                word-break: break-all;
            }

            .no-results {
                text-align: center;
                padding: 40px 20px;
                color: var(--light-text);
            }

            .level-debug {
                background-color: rgba(158, 158, 158, 0.1);
                color: var(--debug-color);
                border-color: var(--debug-color);
            }

            .level-info {
                background-color: rgba(66, 133, 244, 0.1);
                color: var(--info-color);
                border-color: var(--info-color);
            }

            .level-notice {
                background-color: rgba(0, 188, 212, 0.1);
                color: var(--notice-color);
                border-color: var(--notice-color);
            }

            .level-warning {
                background-color: rgba(255, 152, 0, 0.1);
                color: var(--warning-color);
                border-color: var(--warning-color);
            }

            .level-error {
                background-color: rgba(244, 67, 53, 0.1);
                color: var(--error-color);
                border-color: var(--error-color);
            }

            .level-critical {
                background-color: rgba(216, 27, 96, 0.1);
                color: var(--critical-color);
                border-color: var(--critical-color);
            }

            .level-alert {
                background-color: rgba(255, 87, 34, 0.1);
                color: var(--alert-color);
                border-color: var(--alert-color);
            }

            .level-emergency {
                background-color: rgba(142, 36, 170, 0.1);
                color: var(--emergency-color);
                border-color: var(--emergency-color);
            }

            .log-entry.level-debug {
                border-left: 4px solid var(--debug-color);
            }

            .log-entry.level-info {
                border-left: 4px solid var(--info-color);
            }

            .log-entry.level-notice {
                border-left: 4px solid var(--notice-color);
            }

            .log-entry.level-warning {
                border-left: 4px solid var(--warning-color);
            }

            .log-entry.level-error {
                border-left: 4px solid var(--error-color);
            }

            .log-entry.level-critical {
                border-left: 4px solid var(--critical-color);
            }

            .log-entry.level-alert {
                border-left: 4px solid var(--alert-color);
            }

            .log-entry.level-emergency {
                border-left: 4px solid var(--emergency-color);
            }

            .timeline {
                position: relative;
                padding-left: 180px;
                margin-top: 20px;
            }

            .timeline::before {
                content: "";
                position: absolute;
                left: 160px;
                top: 0;
                bottom: 0;
                width: 2px;
                background: var(--border-color);
            }

            .timeline-entry {
                position: relative;
                margin-bottom: 25px;
                min-height: 60px;
            }

            .timeline-entry:last-child {
                margin-bottom: 0;
            }

            .timeline-entry::before {
                content: "";
                position: absolute;
                left: -20px;
                top: 24px;
                width: 12px;
                height: 12px;
                border-radius: 50%;
                background: var(--primary-color);
                z-index: 1;
            }

            .timeline-timestamp {
                position: absolute;
                left: -170px;
                top: 20px;
                color: var(--light-text);
                font-size: 0.85rem;
                line-height: 1.2;
                width: 140px;
                text-align: right;
                padding-right: 20px;
                font-family: "Consolas", monospace;
            }

            .trace-id-highlight {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 10px 15px;
                background: rgba(66, 133, 244, 0.1);
                border-radius: 6px;
                margin-top: 15px;
                border: 1px solid rgba(66, 133, 244, 0.2);
            }

            .log-actions {
                display: flex;
                gap: 10px;
            }

            .labels-btn.expanded {
                background: var(--success-color);
                color: white;
                border-color: var(--success-color);
            }

            ::-webkit-scrollbar {
                width: 8px;
                height: 8px;
            }

            ::-webkit-scrollbar-track {
                background: var(--lighter-bg);
                border-radius: 4px;
            }

            ::-webkit-scrollbar-thumb {
                background: #bbb;
                border-radius: 4px;
            }

            ::-webkit-scrollbar-thumb:hover {
                background: #999;
            }

            @media (max-width: 1024px) {
                .timeline {
                    padding-left: 160px;
                }

                .timeline::before {
                    left: 140px;
                }

                .timeline-timestamp {
                    left: -150px;
                    width: 120px;
                    font-size: 0.8rem;
                }
            }

            @media (max-width: 768px) {
                .container {
                    padding: 15px;
                }

                .header h1 {
                    font-size: 1.8rem;
                }

                .search-box {
                    flex-direction: column;
                }

                .search-box input {
                    border-radius: 6px 6px 0 0;
                    border-right: 1px solid var(--border-color);
                    border-bottom: none;
                }

                .search-box button {
                    border-radius: 0 0 6px 6px;
                    padding: 12px;
                }

                .log-entry {
                    padding: 15px;
                }

                .log-header {
                    flex-direction: column;
                    align-items: flex-start;
                }

                .log-meta {
                    width: 100%;
                    justify-content: space-between;
                }

                .toggle-btn {
                    width: 100%;
                    text-align: center;
                    padding: 8px;
                }

                .timeline {
                    padding-left: 40px;
                }

                .timeline::before {
                    left: 20px;
                }

                .timeline-entry::before {
                    left: -30px;
                }

                .timeline-timestamp {
                    position: relative;
                    left: -35px;
                    top: 0;
                    margin-bottom: 10px;
                    display: inline-block;
                    font-size: 0.85rem;
                }

                .log-actions {
                    width: 100%;
                    justify-content: flex-end;
                    margin-top: 10px;
                }

                .labels-container {
                    max-height: 400px;
                }

                .label-row {
                    display: grid;
                    grid-template-columns: minmax(120px, 30%) 1fr;
                    width: 100%;
                    background: white;
                    border-radius: 4px;
                    border-left: 3px solid var(--primary-color);
                    margin-bottom: 8px;
                    overflow: hidden; /* 确保子元素不会溢出 */
                }

                .label-key {
                    width: 100%;
                    border-right: none;
                    border-bottom: 1px solid var(--border-color);
                    padding: 8px;
                }

                .label-value {
                    width: 100%;
                    padding: 8px;
                }
            }

            @media (max-width: 480px) {
                body {
                    padding: 10px;
                }

                .log-labels {
                    padding: 10px;
                }

                .log-body {
                    padding: 10px;
                    font-size: 0.85rem;
                }
            }

            /* 新增的样式部分 */
            .search-conditions {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 16px;
                margin-bottom: 20px;
            }

            .search-group {
                display: flex;
                flex-direction: column;
            }

            .search-group label {
                margin-bottom: 6px;
                font-weight: 500;
                color: #555;
                font-size: 14px;
            }

            .search-group input,
            .search-group select {
                padding: 10px 12px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 14px;
                transition: border-color 0.3s;
            }

            .search-group input:focus,
            .search-group select:focus {
                border-color: #4285f4;
                outline: none;
                box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
            }

            .search-actions {
                display: flex;
                gap: 12px;
                margin-top: 16px;
            }

            .search-button,
            .reset-button {
                padding: 10px 20px;
                border: none;
                border-radius: 4px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s;
            }

            .search-button {
                background-color: #4285f4;
                color: white;
            }

            .search-button:hover {
                background-color: #3367d6;
            }

            .reset-button {
                background-color: #f1f1f1;
                color: #555;
            }

            .reset-button:hover {
                background-color: #e0e0e0;
            }

            .result-filters {
                margin-top: 12px;
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                align-items: center;
            }

            .filter-tag {
                background-color: #e8f0fe;
                color: #1967d2;
                padding: 4px 10px;
                border-radius: 16px;
                font-size: 13px;
                display: inline-flex;
                align-items: center;
            }

            .limit-warning {
                color: #d93025;
                font-size: 14px;
                margin-left: 8px;
            }

            @media (max-width: 768px) {
                .search-conditions {
                    grid-template-columns: 1fr;
                }
            }
        </style>
        <script>
            // 之前的JavaScript代码保持不变
            function formatTimestamp(timestamp) {
                return timestamp.slice(0, 23);
            }
            function toggleLogBody(id) {
                const body = document.getElementById(id);
                const button = document.getElementById("btn-" + id);

                if (body.classList.contains("collapsed")) {
                    body.classList.remove("collapsed");
                    button.textContent = "折叠日志内容";
                    button.classList.add("expanded");
                } else {
                    body.classList.add("collapsed");
                    button.textContent = "展开日志内容";
                    button.classList.remove("expanded");
                }
            }

            function toggleLabels(id) {
                const labels = document.getElementById(id);
                const button = document.getElementById("btn-" + id);

                if (labels.classList.contains("collapsed")) {
                    labels.classList.remove("collapsed");
                    button.textContent = "折叠日志字段";
                    button.classList.add("expanded");
                } else {
                    labels.classList.add("collapsed");
                    button.textContent = "展开日志字段";
                    button.classList.remove("expanded");
                }
            }

            document.addEventListener("DOMContentLoaded", function () {
                const logBodies = document.querySelectorAll(".log-body");
                const logLabels = document.querySelectorAll(".log-labels");
                logBodies.forEach((body) => {
                    body.classList.add("collapsed");
                });

                logLabels.forEach((labels) => {
                    labels.classList.add("collapsed");
                });

                const timestamps = document.querySelectorAll(
                    ".timeline-timestamp",
                );
                timestamps.forEach(function (element) {
                    const originalTime = element.textContent.trim();
                    element.textContent = formatTimestamp(originalTime);
                    element.title = originalTime;
                });

                // 设置默认时间范围（最近1小时）UTC+8
                const now = new Date();
                const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);

                // 转换为本地时间字符串（UTC+8）
                function toLocalISOString(date) {
                    const offset = date.getTimezoneOffset();
                    const localTime = new Date(
                        date.getTime() - offset * 60 * 1000,
                    );
                    return localTime.toISOString().slice(0, 16);
                }

                document.getElementById("start_time").value =
                    toLocalISOString(oneHourAgo);
                document.getElementById("end_time").value =
                    toLocalISOString(now);
            });
        </script>
    </head>
    <body>
        <div class="container">
            <header class="header">
                <h1>LogTraceFinder</h1>
                <p class="subtitle">开发平台日志查询自助工具</p>
            </header>

            <form method="POST" class="search-form">
                <div class="search-conditions">
                    <!-- companyId 查询 -->
                    <div class="search-group">
                        <label for="company_id">公司ID</label>
                        <input
                            type="text"
                            id="company_id"
                            name="company_id"
                            value="{{ company_id }}"
                            placeholder="输入公司ID"
                        />
                    </div>

                    <!-- 日志内容关键词 -->
                    <div class="search-group">
                        <label for="keyword">关键词</label>
                        <input
                            type="text"
                            id="keyword"
                            name="keyword"
                            value="{{ keyword }}"
                            placeholder="输入日志内容关键词"
                        />
                    </div>

                    <!-- 日志链路ID -->
                    <div class="search-group">
                        <label for="trace_id">日志链路ID</label>
                        <input
                            type="text"
                            id="trace_id"
                            name="trace_id"
                            value="{{ trace_id }}"
                            placeholder="输入TraceID"
                        />
                    </div>

                    <!-- 接口地址 查询 -->
                    <div class="search-group">
                        <label for="request_uri">接口地址</label>
                        <input
                            type="text"
                            id="request_uri"
                            name="request_uri"
                            value="{{ request_uri }}"
                            placeholder="输入接口地址"
                        />
                    </div>

                    <!-- 时间范围选择 -->
                    <div class="search-group">
                        <label for="start_time">开始时间</label>
                        <input
                            type="datetime-local"
                            id="start_time"
                            name="start_time"
                            value="{{ start_time }}"
                        />
                    </div>

                    <div class="search-group">
                        <label for="end_time">结束时间</label>
                        <input
                            type="datetime-local"
                            id="end_time"
                            name="end_time"
                            value="{{ end_time }}"
                        />
                    </div>
                </div>

                <div class="search-actions">
                    <button type="submit" class="search-button">查询</button>
                    <button type="reset" class="reset-button">重置</button>
                </div>
            </form>

            <!-- 结果部分保持不变 -->
            <div class="results">
                {% if logs %}
                <div class="results-header">
                    <h2>查询结果</h2>
                    <p class="result-count">
                        共找到 {{ logs|length }} 条日志记录 {% if limit_reached
                        %}
                        <span class="limit-warning">(已达到最大显示限制)</span>
                        {% endif %}
                    </p>
                </div>

                <div class="timeline">
                    {% for log in logs %}
                    <div class="timeline-entry">
                        <span class="timeline-timestamp"
                            >{{ log.timestamp }}</span
                        >
                        <div class="log-entry level-{{ log.level|lower }}">
                            <div class="log-header">
                                <div class="log-meta">
                                    <span
                                        class="level level-{{ log.level|lower }}"
                                        >{{ log.level }}</span
                                    >
                                    <span
                                        class="level level-{{ log.level|lower }}"
                                        >{{ log.serviceName }}</span
                                    >
                                </div>
                                <div class="log-actions">
                                    <button
                                        class="toggle-btn"
                                        id="btn-log-{{ loop.index }}"
                                        onclick="toggleLogBody('log-{{ loop.index }}')"
                                    >
                                        展开日志内容
                                    </button>
                                    {% if log.labels %}
                                    <button
                                        class="toggle-btn labels-btn"
                                        id="btn-labels-{{ loop.index }}"
                                        onclick="toggleLabels('labels-{{ loop.index }}')"
                                    >
                                        展开日志字段
                                    </button>
                                    {% endif %}
                                </div>
                            </div>

                            {% if log.labels %}
                            <div
                                id="labels-{{ loop.index }}"
                                class="log-labels collapsed"
                            >
                                <div class="labels-container">
                                    {% for key, value in log.labels.items() %}
                                    <div class="label-row">
                                        <span class="label-key"
                                            >{{ key }}:</span
                                        >
                                        <span class="label-value"
                                            >{{ value }}</span
                                        >
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}

                            <div
                                id="log-{{ loop.index }}"
                                class="log-body collapsed"
                            >
                                {% if log.body is string %}
                                <pre>{{ log.body }}</pre>
                                {% else %}
                                <pre>{{ log.body|tojson(indent=2) }}</pre>
                                {% endif %}
                            </div>

                            <div class="log-footer">
                                <div class="trace-id-highlight">
                                    <span class="trace-id-label">追踪ID:</span>
                                    <span class="trace-id"
                                        >{{ log.traceID }}</span
                                    >
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% elif request.method == 'POST' %}
                <div class="no-results">
                    <p>没有找到符合条件的日志记录，请尝试其他查询条件</p>
                </div>
                {% endif %}
            </div>
        </div>
    </body>
</html>
